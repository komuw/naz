

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>naz.client &mdash; naz v0.7.6 documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://komuw.github.io/naz/_modules/naz/client.html"/>
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> naz
          

          
          </a>

          
            
            
              <div class="version">
                v0.7.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction to naz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../step_by_step_demo.html">Example demo of using naz</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../protocol.html">protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correlater.html">correlater</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hooks.html">hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../codec.html">codec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../broker.html">broker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ratelimiter.html">ratelimiter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sequence.html">sequence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../throttle.html">throttle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../state.html">state</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../log.html">log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">naz</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>naz.client</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for naz.client</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="c1"># pytype: disable=pyi-error</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">hooks</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">protocol</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">sequence</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">throttle</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">correlater</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ratelimiter</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">codec</span> <span class="k">as</span> <span class="n">the_codec</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">broker</span> <span class="k">as</span> <span class="n">the_broker</span>


<span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SmppCommand</span><span class="p">,</span>
    <span class="n">CommandStatus</span><span class="p">,</span>
    <span class="n">SmppDataCoding</span><span class="p">,</span>
    <span class="n">SmppOptionalTag</span><span class="p">,</span>
    <span class="n">SmppSessionState</span><span class="p">,</span>
    <span class="n">SmppCommandStatus</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># pytype: disable=pyi-error</span>


<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../client.html#naz.client.Client">[docs]</a><span class="k">class</span> <span class="nc">Client</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The SMPP client that will interact with SMSC/server.</span>

<span class="sd">    Example declaration:</span>

<span class="sd">    .. highlight:: python</span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">        import os</span>
<span class="sd">        import asyncio</span>
<span class="sd">        import naz</span>

<span class="sd">        broker = naz.broker.SimpleBroker(maxsize=1000)</span>
<span class="sd">        client = naz.Client(</span>
<span class="sd">                smsc_host=&quot;127.0.0.1&quot;,</span>
<span class="sd">                smsc_port=2775,</span>
<span class="sd">                system_id=&quot;smppclient1&quot;,</span>
<span class="sd">                password=os.getenv(&quot;password&quot;, &quot;password&quot;),</span>
<span class="sd">                broker=broker,</span>
<span class="sd">            )</span>

<span class="sd">        # 1. connect to the SMSC host</span>
<span class="sd">        # 2. bind to the SMSC host</span>
<span class="sd">        # 3. send any queued messages to SMSC</span>
<span class="sd">        # 4. read any data from SMSC</span>
<span class="sd">        # 5. continually check the state of the SMSC</span>
<span class="sd">        tasks = asyncio.gather(</span>
<span class="sd">            client.connect(),</span>
<span class="sd">            client.tranceiver_bind(),</span>
<span class="sd">            client.dequeue_messages(),</span>
<span class="sd">            client.receive_data(),</span>
<span class="sd">            client.enquire_link(),</span>
<span class="sd">        )</span>
<span class="sd">        loop = asyncio.get_event_loop()</span>
<span class="sd">        loop.run_until_complete(tasks)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Client.__init__"><a class="viewcode-back" href="../../client.html#naz.client.Client.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">smsc_host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">smsc_port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">system_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">broker</span><span class="p">:</span> <span class="n">the_broker</span><span class="o">.</span><span class="n">BaseBroker</span><span class="p">,</span>
        <span class="n">client_id</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">system_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">addr_ton</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">addr_npi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">address_range</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">interface_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
        <span class="n">enquire_link_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">55.00</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">codec</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">the_codec</span><span class="o">.</span><span class="n">BaseCodec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rateLimiter</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">ratelimiter</span><span class="o">.</span><span class="n">BaseRateLimiter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hook</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">hooks</span><span class="o">.</span><span class="n">BaseHook</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sequence_generator</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">sequence</span><span class="o">.</span><span class="n">BaseSequenceGenerator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">throttle_handler</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">throttle</span><span class="o">.</span><span class="n">BaseThrottleHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">correlation_handler</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">correlater</span><span class="o">.</span><span class="n">BaseCorrelater</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">drain_duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">8.00</span><span class="p">,</span>
        <span class="n">socket_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            smsc_host:	the IP address(or domain name) of the SMSC gateway/server</span>
<span class="sd">            smsc_port:	the port at which SMSC is listening on</span>
<span class="sd">            system_id:	Identifies the ESME system requesting to bind as a transceiver with the SMSC.</span>
<span class="sd">            password:	The password to be used by the SMSC to authenticate the ESME requesting to bind.</span>
<span class="sd">            broker:	python class instance implementing some queueing mechanism. \</span>
<span class="sd">                messages to be sent to SMSC are queued using the said mechanism before been sent</span>
<span class="sd">            client_id:	a unique string identifying a naz client class instance</span>
<span class="sd">            system_type:	Identifies the type of ESME system requesting to bind with the SMSC.</span>
<span class="sd">            addr_ton:	Type of Number of the ESME address.</span>
<span class="sd">            addr_npi:	Numbering Plan Indicator (NPI) for ESME address(es) served via this SMPP transceiver session</span>
<span class="sd">            address_range:	A single ESME address or a range of ESME addresses served via this SMPP transceiver session.</span>
<span class="sd">            interface_version:	Indicates the version of the SMPP protocol supported by the ESME.</span>
<span class="sd">            enquire_link_interval:	time in seconds to wait before sending an enquire_link request to SMSC to check on its status</span>
<span class="sd">            logger: python `logger &lt;https://docs.python.org/3/library/logging.html#logging.Logger&gt;`_ instance to be used for logging</span>
<span class="sd">            codec: python class instance, that is a child class of `naz.codec.BaseCodec` to be used to encode/decode messages.</span>
<span class="sd">            rateLimiter: python class instance implementing rate limitation</span>
<span class="sd">            hook: python class instance implemeting functionality/hooks to be called by naz \</span>
<span class="sd">                just before sending request to SMSC and just after getting response from SMSC</span>
<span class="sd">            sequence_generator:	python class instance used to generate sequence_numbers</span>
<span class="sd">            throttle_handler: python class instance implementing functionality of what todo when naz starts getting throttled responses from SMSC</span>
<span class="sd">            correlation_handler: A python class instance that naz uses to store relations between \</span>
<span class="sd">                SMPP sequence numbers and user applications&#39; log_id&#39;s and/or hook_metadata.</span>
<span class="sd">            drain_duration: duration in seconds that `naz` will wait for after receiving a termination signal.</span>
<span class="sd">            socket_timeout: duration that `naz` will wait, for socket/connection related activities with SMSC, before timing out</span>

<span class="sd">        Raises:</span>
<span class="sd">            NazClientError: raised if there’s an error instantiating a naz Client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_client_args</span><span class="p">(</span>
            <span class="n">smsc_host</span><span class="o">=</span><span class="n">smsc_host</span><span class="p">,</span>
            <span class="n">smsc_port</span><span class="o">=</span><span class="n">smsc_port</span><span class="p">,</span>
            <span class="n">system_id</span><span class="o">=</span><span class="n">system_id</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
            <span class="n">broker</span><span class="o">=</span><span class="n">broker</span><span class="p">,</span>
            <span class="n">client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">,</span>
            <span class="n">system_type</span><span class="o">=</span><span class="n">system_type</span><span class="p">,</span>
            <span class="n">addr_ton</span><span class="o">=</span><span class="n">addr_ton</span><span class="p">,</span>
            <span class="n">addr_npi</span><span class="o">=</span><span class="n">addr_npi</span><span class="p">,</span>
            <span class="n">address_range</span><span class="o">=</span><span class="n">address_range</span><span class="p">,</span>
            <span class="n">interface_version</span><span class="o">=</span><span class="n">interface_version</span><span class="p">,</span>
            <span class="n">enquire_link_interval</span><span class="o">=</span><span class="n">enquire_link_interval</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">codec</span><span class="o">=</span><span class="n">codec</span><span class="p">,</span>
            <span class="n">rateLimiter</span><span class="o">=</span><span class="n">rateLimiter</span><span class="p">,</span>
            <span class="n">hook</span><span class="o">=</span><span class="n">hook</span><span class="p">,</span>
            <span class="n">sequence_generator</span><span class="o">=</span><span class="n">sequence_generator</span><span class="p">,</span>
            <span class="n">throttle_handler</span><span class="o">=</span><span class="n">throttle_handler</span><span class="p">,</span>
            <span class="n">correlation_handler</span><span class="o">=</span><span class="n">correlation_handler</span><span class="p">,</span>
            <span class="n">drain_duration</span><span class="o">=</span><span class="n">drain_duration</span><span class="p">,</span>
            <span class="n">socket_timeout</span><span class="o">=</span><span class="n">socket_timeout</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_PID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsc_host</span> <span class="o">=</span> <span class="n">smsc_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsc_port</span> <span class="o">=</span> <span class="n">smsc_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_id</span> <span class="o">=</span> <span class="n">system_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">broker</span>

        <span class="k">if</span> <span class="n">client_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">system_type</span> <span class="o">=</span> <span class="n">system_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface_version</span> <span class="o">=</span> <span class="n">interface_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr_ton</span> <span class="o">=</span> <span class="n">addr_ton</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr_npi</span> <span class="o">=</span> <span class="n">addr_npi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address_range</span> <span class="o">=</span> <span class="n">address_range</span>

        <span class="k">if</span> <span class="n">sequence_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span> <span class="o">=</span> <span class="n">sequence_generator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">SimpleSequenceGenerator</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span> <span class="o">=</span> <span class="mh">0x7FFFFFFF</span>

        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">SimpleLogger</span><span class="p">(</span>
                <span class="s2">&quot;naz.client&quot;</span><span class="p">,</span>
                <span class="n">log_metadata</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;smsc_host&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smsc_host</span><span class="p">,</span>
                    <span class="s2">&quot;system_id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">,</span>
                    <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
                    <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PID</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sanity_check_logger</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">codec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codec</span> <span class="o">=</span> <span class="n">the_codec</span><span class="o">.</span><span class="n">SimpleCodec</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enquire_link_interval</span> <span class="o">=</span> <span class="n">enquire_link_interval</span>

        <span class="c1"># see section 5.1.2.1 of smpp ver 3.4 spec document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER</span><span class="p">:</span> <span class="mh">0x00000009</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER_RESP</span><span class="p">:</span> <span class="mh">0x80000009</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND</span><span class="p">:</span> <span class="mh">0x00000006</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND_RESP</span><span class="p">:</span> <span class="mh">0x80000006</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM</span><span class="p">:</span> <span class="mh">0x00000004</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM_RESP</span><span class="p">:</span> <span class="mh">0x80000004</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM</span><span class="p">:</span> <span class="mh">0x00000005</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM_RESP</span><span class="p">:</span> <span class="mh">0x80000005</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK</span><span class="p">:</span> <span class="mh">0x00000015</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK_RESP</span><span class="p">:</span> <span class="mh">0x80000015</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">GENERIC_NACK</span><span class="p">:</span> <span class="mh">0x80000000</span><span class="p">,</span>
            <span class="c1"># naz currently does not handle the following smpp commands.</span>
            <span class="c1"># open a github issue if you use naz and require support of a command in this list</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_RECEIVER_RESP</span><span class="p">:</span> <span class="mh">0x80000001</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSMITTER_RESP</span><span class="p">:</span> <span class="mh">0x80000002</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">QUERY_SM</span><span class="p">:</span> <span class="mh">0x00000003</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">QUERY_SM_RESP</span><span class="p">:</span> <span class="mh">0x80000003</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">REPLACE_SM</span><span class="p">:</span> <span class="mh">0x00000007</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">REPLACE_SM_RESP</span><span class="p">:</span> <span class="mh">0x80000007</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">CANCEL_SM</span><span class="p">:</span> <span class="mh">0x00000008</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">CANCEL_SM_RESP</span><span class="p">:</span> <span class="mh">0x80000008</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_MULTI</span><span class="p">:</span> <span class="mh">0x00000021</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_MULTI_RESP</span><span class="p">:</span> <span class="mh">0x80000021</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">OUTBIND</span><span class="p">:</span> <span class="mh">0x0000000B</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ALERT_NOTIFICATION</span><span class="p">:</span> <span class="mh">0x00000102</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DATA_SM</span><span class="p">:</span> <span class="mh">0x00000103</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DATA_SM_RESP</span><span class="p">:</span> <span class="mh">0x80000103</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_A</span><span class="p">:</span> <span class="mh">0x0000000A</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_B</span><span class="p">:</span> <span class="mh">0x8000000A</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_C</span><span class="p">:</span> <span class="mh">0x00000100</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_D</span><span class="p">:</span> <span class="mh">0x80000100</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_E</span><span class="p">:</span> <span class="mh">0x00000101</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_F</span><span class="p">:</span> <span class="mh">0x80000101</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_G</span><span class="p">:</span> <span class="mh">0x80000102</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_A</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x0000000C</span><span class="p">,</span> <span class="mh">0x00000014</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_B</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x8000000B</span><span class="p">,</span> <span class="mh">0x80000014</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_C</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x00000016</span><span class="p">,</span> <span class="mh">0x00000020</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_D</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x80000016</span><span class="p">,</span> <span class="mh">0x80000020</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_E</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x00000022</span><span class="p">,</span> <span class="mh">0x000000FF</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_F</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x80000022</span><span class="p">,</span> <span class="mh">0x800000FF</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_G</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x00010300</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_H</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x00010000</span><span class="p">,</span> <span class="mh">0x000101FF</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_LIST_I</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x80010000</span><span class="p">,</span> <span class="mh">0x800101FF</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_FOR_SMPP_EXTENSION_A</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x00000104</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_FOR_SMPP_EXTENSION_B</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x80000104</span><span class="p">,</span> <span class="mh">0x8000FFFF</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_FOR_SMSC_VENDOR_A</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x00010200</span><span class="p">,</span> <span class="mh">0x000102FF</span><span class="p">],</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">RESERVED_FOR_SMSC_VENDOR_B</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x80010200</span><span class="p">,</span> <span class="mh">0x800102FF</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_coding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_data_coding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamReader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamWriter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">rateLimiter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rateLimiter</span> <span class="o">=</span> <span class="n">rateLimiter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rateLimiter</span> <span class="o">=</span> <span class="n">ratelimiter</span><span class="o">.</span><span class="n">SimpleRateLimiter</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">hook</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">hooks</span><span class="o">.</span><span class="n">SimpleHook</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">throttle_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span> <span class="o">=</span> <span class="n">throttle_handler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span> <span class="o">=</span> <span class="n">throttle</span><span class="o">.</span><span class="n">SimpleThrottleHandler</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># class storing SMPP sequence_number and their corresponding log_id and/or hook_metadata</span>
        <span class="c1"># this will be used to track different pdu&#39;s and user generated log_id</span>
        <span class="k">if</span> <span class="n">correlation_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span> <span class="o">=</span> <span class="n">correlation_handler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span> <span class="o">=</span> <span class="n">correlater</span><span class="o">.</span><span class="n">SimpleCorrelater</span><span class="p">()</span>

        <span class="c1"># the messages that are published to a queue by either naz</span>
        <span class="c1"># or user application should be versioned.</span>
        <span class="c1"># This version will enable naz to be able to evolve in future;</span>
        <span class="c1"># eg a future version of naz could add/remove the number of required items in a message.</span>
        <span class="c1"># This is a bit similar to: http://docs.celeryproject.org/en/latest/internals/protocol.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">naz_message_protocol_version</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">CLOSED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="o">=</span> <span class="mi">16</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drain_duration</span> <span class="o">=</span> <span class="n">drain_duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket_timeout</span> <span class="o">=</span> <span class="n">socket_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drain_lock</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span></div>

        <span class="c1"># For exceptions, we try and avoid catch-all blocks. Instead we catch only the exceptions we expect.</span>
        <span class="c1"># Exception hierarchy: https://docs.python.org/3/library/exceptions.html#exception-hierarchy</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate_client_args</span><span class="p">(</span>
        <span class="n">smsc_host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">smsc_port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">system_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">broker</span><span class="p">:</span> <span class="n">the_broker</span><span class="o">.</span><span class="n">BaseBroker</span><span class="p">,</span>
        <span class="n">client_id</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">system_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">addr_ton</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">addr_npi</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">address_range</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">interface_version</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">enquire_link_interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">],</span>
        <span class="n">codec</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">the_codec</span><span class="o">.</span><span class="n">BaseCodec</span><span class="p">],</span>
        <span class="n">rateLimiter</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">ratelimiter</span><span class="o">.</span><span class="n">BaseRateLimiter</span><span class="p">],</span>
        <span class="n">hook</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">hooks</span><span class="o">.</span><span class="n">BaseHook</span><span class="p">],</span>
        <span class="n">sequence_generator</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">sequence</span><span class="o">.</span><span class="n">BaseSequenceGenerator</span><span class="p">],</span>
        <span class="n">throttle_handler</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">throttle</span><span class="o">.</span><span class="n">BaseThrottleHandler</span><span class="p">],</span>
        <span class="n">correlation_handler</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">correlater</span><span class="o">.</span><span class="n">BaseCorrelater</span><span class="p">],</span>
        <span class="n">drain_duration</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">socket_timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that the arguments to `naz.Client` are okay.</span>
<span class="sd">        It raises an Exception that comprises of a list of Exceptions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="ne">ValueError</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smsc_host</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`smsc_host` should be of type:: `str` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">smsc_host</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smsc_port</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`smsc_port` should be of type:: `int` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">smsc_port</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">system_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`system_id` should be of type:: `str` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">system_id</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`password` should be of type:: `str` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">broker</span><span class="p">,</span> <span class="n">the_broker</span><span class="o">.</span><span class="n">BaseBroker</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`broker` should be of type:: `naz.broker.BaseBroker` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">broker</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`client_id` should be of type:: `None` or `str` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">system_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`system_type` should be of type:: `str` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">system_type</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">addr_ton</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`addr_ton` should be of type:: `int` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">addr_ton</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">addr_npi</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`addr_npi` should be of type:: `int` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">addr_npi</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">address_range</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`address_range` should be of type:: `str` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">address_range</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interface_version</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`interface_version` should be of type:: `int` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">interface_version</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">enquire_link_interval</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`enquire_link_interval` should be of type:: `float` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">enquire_link_interval</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`logger` should be of type:: `None` or `logging.Logger` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">the_codec</span><span class="o">.</span><span class="n">BaseCodec</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`codec` should be of type:: `None` or `naz.codec.BaseCodec` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">codec</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rateLimiter</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">ratelimiter</span><span class="o">.</span><span class="n">BaseRateLimiter</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`rateLimiter` should be of type:: `None` or `naz.ratelimiter.BaseRateLimiter` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">rateLimiter</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">hooks</span><span class="o">.</span><span class="n">BaseHook</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`hook` should be of type:: `None` or `naz.hooks.BaseHook` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence_generator</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">sequence</span><span class="o">.</span><span class="n">BaseSequenceGenerator</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`sequence_generator` should be of type:: `None` or `naz.sequence.BaseSequenceGenerator` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">sequence_generator</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">throttle_handler</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">throttle</span><span class="o">.</span><span class="n">BaseThrottleHandler</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`throttle_handler` should be of type:: `None` or `naz.throttle.BaseThrottleHandler` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">throttle_handler</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">correlation_handler</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">correlater</span><span class="o">.</span><span class="n">BaseCorrelater</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`correlation_handler` should be of type:: `None` or `naz.correlater.BaseCorrelater` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">correlation_handler</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drain_duration</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`drain_duration` should be of type:: `float` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">drain_duration</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">socket_timeout</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`socket_timeout` should be of type:: `float` You entered: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">socket_timeout</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">NazClientError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sanity_check_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        called when instantiating the Client just to make sure the supplied</span>
<span class="sd">        logger can log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;sanity_check_logger&quot;</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">log_data</span><span class="p">):</span>
        <span class="c1"># if the supplied logger is unable to log; we move on</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">log_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_find_data_coding</span><span class="p">(</span><span class="n">encoding</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">SmppDataCoding</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="n">val</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;That encoding: `</span><span class="si">{0}</span><span class="s2">` is not recognised.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_search_by_command_id_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_id_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">__range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">command_id_code</span> <span class="ow">in</span> <span class="n">__range</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">command_id_code</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">key</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_search_by_command_status_value</span><span class="p">(</span>
        <span class="n">command_status_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">CommandStatus</span><span class="p">]:</span>
        <span class="c1"># TODO: find a cheaper(better) way of doing this</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">__range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">command_status_value</span> <span class="ow">in</span> <span class="n">__range</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">val</span>
                <span class="k">if</span> <span class="n">command_status_value</span> <span class="o">==</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">val</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_retry_after</span><span class="p">(</span><span class="n">current_retries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        retries will happen in this sequence;</span>
<span class="sd">        1min, 2min, 4min, 8min, 16min, 32min, 16min, 16min, 16min ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO:</span>
        <span class="c1"># 1. give users ability to bring their own retry algorithms.</span>
        <span class="c1"># 2. add jitter</span>
        <span class="k">if</span> <span class="n">current_retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_retries</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">current_retries</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">16</span>  <span class="c1"># 16 minutes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">60</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">current_retries</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_msg_to_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns decoded string from bytes with any password removed.</span>
<span class="sd">        the returned string is safe to log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;unable to decode msg&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="ow">in</span> <span class="n">log_msg</span><span class="p">:</span>
                <span class="c1"># do not log password, redact it from logs.</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="n">log_msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{REDACTED}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">UnicodeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># in future we may want to do something custom</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">log_msg</span>

<div class="viewcode-block" id="Client.connect"><a class="viewcode-back" href="../../client.html#naz.client.Client.connect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make a network connection to SMSC server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">log_id</span>
            <span class="k">if</span> <span class="n">log_id</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.connect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smsc_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smsc_port</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">reader</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">writer</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">)</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_timeout</span><span class="p">)</span>
            <span class="c1"># A socket object can be in one of three modes: blocking, non-blocking, or timeout.</span>
            <span class="c1"># At the OS level, sockets in timeout mode are internally set in non-blocking mode.</span>
            <span class="c1"># https://docs.python.org/3/library/socket.html#notes-on-socket-timeouts</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.connect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">OPEN</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="ne">OSError</span><span class="p">,</span>
            <span class="ne">ConnectionError</span><span class="p">,</span>
            <span class="ne">TimeoutError</span><span class="p">,</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">herror</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.connect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Client.tranceiver_bind"><a class="viewcode-back" href="../../client.html#naz.client.Client.tranceiver_bind">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">tranceiver_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send a BIND_TRANSCEIVER pdu to SMSC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER</span>
        <span class="k">if</span> <span class="n">log_id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.tranceiver_bind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">body</span>
            <span class="c1"># system_id is a C-Octet string, which is a series of ASCII characters terminated with the NULL character.</span>
            <span class="c1"># see; section 3.1 of SMPP spec</span>
            <span class="c1"># Thus we need to encode C-Octet strings as ascii and also terminate them with NULL char(chr(0).encode())</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_type</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_version</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr_ton</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr_npi</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_range</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="c1"># the status for success see section 5.1.3</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.tranceiver_bind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span><span class="p">:</span>
            <span class="c1"># prevent third party sequence_generators from ruining our party</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;the sequence_number: </span><span class="si">{0}</span><span class="s2"> is greater than the max: </span><span class="si">{1}</span><span class="s2"> allowed by SMPP spec.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sequence_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># associate sequence_number with log_id.</span>
        <span class="c1"># this will enable us to also associate responses and thus enhancing traceability of all workflows</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                <span class="n">hook_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.tranceiver_bind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>
        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.tranceiver_bind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.enquire_link"><a class="viewcode-back" href="../../client.html#naz.client.Client.enquire_link">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">enquire_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TESTING</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send an ENQUIRE_LINK pdu to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TESTING: indicates whether this method is been called while running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sleep during startup so that `naz` can have had time to connect &amp; bind</span>
        <span class="c1"># we rely on `enquire_link` to kick on `re_establish_conn_bind`</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">!=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">BOUND_TRX</span><span class="p">:</span>
            <span class="n">retry_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_timeout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;current_session_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;awaiting naz to change session state to `BOUND_TRX`. sleeping for </span><span class="si">{0:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">retry_after</span>
                    <span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;client is shutdown&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># body</span>
            <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

            <span class="c1"># header</span>
            <span class="n">command_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
            <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
            <span class="n">command_status</span> <span class="o">=</span> <span class="mh">0x00000000</span>  <span class="c1"># not used for `enquire_link`</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span><span class="p">:</span>
                <span class="c1"># prevent third party sequence_generators from ruining our party</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;the sequence_number: </span><span class="si">{0}</span><span class="s2"> is greater than the max: </span><span class="si">{1}</span><span class="s2"> allowed by SMPP spec.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sequence_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                    <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">hook_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span>
            <span class="p">)</span>
            <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
            <span class="c1"># dont queue enquire_link in SimpleBroker since we dont want it to be behind 10k msgs etc</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">full_pdu</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enquire_link_interval</span><span class="p">)</span></div>

<div class="viewcode-block" id="Client.enquire_link_resp"><a class="viewcode-back" href="../../client.html#naz.client.Client.enquire_link_resp">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">enquire_link_resp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send an ENQUIRE_LINK_RESP pdu to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            sequence_number: SMPP sequence_number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK_RESP</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
                <span class="n">protocol</span><span class="o">.</span><span class="n">EnquireLinkResp</span><span class="p">(</span>
                    <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">naz_message_protocol_version</span><span class="p">,</span>
                    <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link_resp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.unbind_resp"><a class="viewcode-back" href="../../client.html#naz.client.Client.unbind_resp">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">unbind_resp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send an UNBIND_RESP pdu to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            sequence_number: SMPP sequence_number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND_RESP</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">sequence_number</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>

        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="c1"># dont queue unbind_resp in SimpleBroker since we dont want it to be behind 10k msgs etc</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.deliver_sm_resp"><a class="viewcode-back" href="../../client.html#naz.client.Client.deliver_sm_resp">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">deliver_sm_resp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send a DELIVER_SM_RESP pdu to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            sequence_number: SMPP sequence_number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM_RESP</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.deliver_sm_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span>
                <span class="n">protocol</span><span class="o">.</span><span class="n">DeliverSmResp</span><span class="p">(</span>
                    <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">naz_message_protocol_version</span><span class="p">,</span>
                    <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">message_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.deliver_sm_resp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.deliver_sm_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

    <span class="c1"># this method just enqueues a submit_sm msg to queue</span>
<div class="viewcode-block" id="Client.submit_message"><a class="viewcode-back" href="../../client.html#naz.client.Client.submit_message">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto_msg</span><span class="p">:</span> <span class="n">protocol</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        enqueues any kind of pdu to :attr:`broker &lt;Client.broker&gt;`</span>
<span class="sd">        That PDU will later on be sent to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TODO: docs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">smpp_command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.submit_message&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">short_message</span><span class="p">,</span>
                <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">source_addr</span><span class="p">,</span>
                <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">destination_addr</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">proto_msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.submit_message&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.submit_message&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">short_message</span><span class="p">,</span>
                <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">source_addr</span><span class="p">,</span>
                <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">destination_addr</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.submit_sm"><a class="viewcode-back" href="../../client.html#naz.client.Client.submit_sm">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_sm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto_msg</span><span class="p">:</span> <span class="n">protocol</span><span class="o">.</span><span class="n">SubmitSM</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        enqueues a SUBMIT_SM pdu to :attr:`broker &lt;Client.broker&gt;`</span>
<span class="sd">        That PDU will later on be sent to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TODO: docs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_message</span><span class="p">(</span><span class="n">proto_msg</span><span class="o">=</span><span class="n">proto_msg</span><span class="p">)</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_build_enquire_link_resp_pdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto_msg</span><span class="p">:</span> <span class="n">protocol</span><span class="o">.</span><span class="n">EnquireLinkResp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK_RESP</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">log_id</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">sequence_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._build_enquire_link_resp_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">sequence_number</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>

        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._build_enquire_link_resp_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">full_pdu</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_build_deliver_sm_pdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto_msg</span><span class="p">:</span> <span class="n">protocol</span><span class="o">.</span><span class="n">DeliverSmResp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM_RESP</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">log_id</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">message_id</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">sequence_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._build_deliver_sm_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">body</span> <span class="o">+</span> <span class="n">message_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">sequence_number</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>

        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._build_deliver_sm_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">full_pdu</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_build_submit_sm_pdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proto_msg</span><span class="p">:</span> <span class="n">protocol</span><span class="o">.</span><span class="n">SubmitSM</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        builds a SUBMIT_SM pdu.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            proto_msg: an instance of `naz.protocol.SubmitSM`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># HEADER::</span>
        <span class="c1"># submit_sm has the following pdu header:</span>
        <span class="c1"># command_length, int, 4octet</span>
        <span class="c1"># command_id, int, 4octet. `submit_sm`</span>
        <span class="c1"># command_status, int, 4octet. Not used. Set to NULL</span>
        <span class="c1"># sequence_number, int, 4octet.  The associated submit_sm_resp PDU will echo this sequence number.</span>

        <span class="c1"># BODY::</span>
        <span class="c1"># submit_sm has the following pdu body. NB: They SHOULD be put in the body in the ORDER presented here.</span>
        <span class="c1"># service_type, c-octet str, max 6octet. eg NULL, &quot;USSD&quot;, &quot;CMT&quot; etc</span>
        <span class="c1"># source_addr_ton, int , 1octet,</span>
        <span class="c1"># source_addr_npi, int, 1octet</span>
        <span class="c1"># source_addr, c-octet str, max 21octet. eg; This is usually the senders phone Number</span>
        <span class="c1"># dest_addr_ton, int, 1octet</span>
        <span class="c1"># dest_addr_npi, int, 1octet</span>
        <span class="c1"># destination_addr,  C-Octet String, max 21 octet. eg; This is usually the recipients phone Number</span>
        <span class="c1"># esm_class, int, 1octet</span>
        <span class="c1"># protocol_id, int, 1octet</span>
        <span class="c1"># priority_flag, int, 1octet</span>
        <span class="c1"># schedule_delivery_time, c-octet str, 1 or 17 octets. NULL for immediate message delivery.</span>
        <span class="c1"># validity_period, c-octet str, 1 or 17 octets.  NULL for SMSC default.</span>
        <span class="c1"># registered_delivery, int, 1octet</span>
        <span class="c1"># replace_if_present_flag, int, 1octet</span>
        <span class="c1"># data_coding, int, 1octet. Defines the encoding scheme of the short message user data. Bits 7 6 5 4 3 2 1 0</span>
        <span class="c1"># sm_default_msg_id, int, 1octet. SMSC index of a pre-defined(`canned`) message.  If not using an SMSC canned message, set to NULL</span>
        <span class="c1"># sm_length, int, 1octet. Length in octets of the `short_message`.</span>
        <span class="c1"># short_message, Octet-String(NOT c-octet str), 0-254 octets.</span>
        <span class="c1"># NB: 1. Applications which need to send messages longer than 254 octets should use the `message_payload` optional parameter.</span>
        <span class="c1">#        In this case the `sm_length` field should be set to zero</span>
        <span class="c1">#        u cant use both `short_message` and `message_payload`</span>
        <span class="c1">#     2. Octet String - A series of octets, not necessarily NULL terminated.</span>

        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">log_id</span>
        <span class="n">hook_metadata</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">hook_metadata</span>
        <span class="n">short_message</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">short_message</span>
        <span class="n">source_addr</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">source_addr</span>
        <span class="n">destination_addr</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">destination_addr</span>
        <span class="n">service_type</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">service_type</span>
        <span class="n">source_addr_ton</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">source_addr_ton</span>
        <span class="n">source_addr_npi</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">source_addr_npi</span>
        <span class="n">dest_addr_ton</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">dest_addr_ton</span>
        <span class="n">dest_addr_npi</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">dest_addr_npi</span>
        <span class="n">esm_class</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">esm_class</span>
        <span class="n">protocol_id</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">protocol_id</span>
        <span class="n">priority_flag</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">priority_flag</span>
        <span class="n">schedule_delivery_time</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">schedule_delivery_time</span>
        <span class="n">validity_period</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">validity_period</span>
        <span class="n">registered_delivery</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">registered_delivery</span>
        <span class="n">replace_if_present_flag</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">replace_if_present_flag</span>
        <span class="n">sm_default_msg_id</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">sm_default_msg_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._build_submit_sm_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">short_message</span><span class="p">,</span>
                <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">source_addr</span><span class="p">,</span>
                <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">destination_addr</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">encoded_short_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">short_message</span><span class="p">)</span>
        <span class="n">sm_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded_short_message</span><span class="p">)</span>

        <span class="c1"># body</span>
        <span class="c1"># SUBMIT_SM KKKK</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">body</span>
            <span class="o">+</span> <span class="n">service_type</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">source_addr_ton</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">source_addr_npi</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">source_addr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">dest_addr_ton</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">dest_addr_npi</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">destination_addr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">esm_class</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">protocol_id</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">priority_flag</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">schedule_delivery_time</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">validity_period</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">registered_delivery</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">replace_if_present_flag</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_coding</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">sm_default_msg_id</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">sm_length</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">short_message</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="c1"># the status for success see section 5.1.3</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="mh">0x00000000</span>  <span class="c1"># not used for `submit_sm`</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._build_submit_sm_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span><span class="p">:</span>
            <span class="c1"># prevent third party sequence_generators from ruining our party</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;the sequence_number: </span><span class="si">{0}</span><span class="s2"> is greater than the max: </span><span class="si">{1}</span><span class="s2"> allowed by SMPP spec.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sequence_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._build_submit_sm_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>
        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._build_submit_sm_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">short_message</span><span class="p">,</span>
                <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">source_addr</span><span class="p">,</span>
                <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">destination_addr</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">full_pdu</span>

<div class="viewcode-block" id="Client.re_establish_conn_bind"><a class="viewcode-back" href="../../client.html#naz.client.Client.re_establish_conn_bind">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">re_establish_conn_bind</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">smpp_command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">TESTING</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called if connection is lost. It reconnects &amp; rebinds to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TESTING: indicates whether this method is been called while running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the only reason this method is called is because connection has closed.</span>
        <span class="c1"># so lets set the session state to reflect that fact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">CLOSED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.re_establish_conn_bind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;connection_lost&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">is_closing</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.re_establish_conn_bind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;cleanly shutting down client.&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 1. re-connect</span>
        <span class="c1"># 2. re-bind</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">==</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="c1"># state can only be open if `client.connect` succeded</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tranceiver_bind</span><span class="p">(</span><span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.re_establish_conn_bind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
            <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Client.send_data"><a class="viewcode-back" href="../../client.html#naz.client.Client.send_data">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">smpp_command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">log_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hook_metadata</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends PDU&#39;s to SMSC over a network connection.</span>
<span class="sd">        This method does not block; it buffers the data and arranges for it to be sent out asynchronously.</span>
<span class="sd">        It also accts as a flow control method that interacts with the IO write buffer.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            smpp_command: type of PDU been sent. eg bind_transceiver</span>
<span class="sd">            msg: PDU to be sent to SMSC over the network connection.</span>
<span class="sd">            log_id: a unique identify of this request</span>
<span class="sd">            hook_metadata: additional metadata that you would like to be passed on to hooks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo: look at `set_write_buffer_limits` and `get_write_buffer_limits` methods</span>
        <span class="c1"># print(&quot;get_write_buffer_limits:&quot;, writer.transport.get_write_buffer_limits())</span>
        <span class="n">log_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_to_log</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
                <span class="s2">&quot;connection_lost&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">is_closing</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># check session state to see if we can send messages.</span>
        <span class="c1"># see section 2.3 of SMPP spec document v3.4</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">==</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;smpp_command `</span><span class="si">{0}</span><span class="s2">` cannot be sent to SMSC when the client session state is `</span><span class="si">{1}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
                    <span class="s2">&quot;current_session_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">==</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">OPEN</span>
            <span class="ow">and</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK</span>
        <span class="p">):</span>
            <span class="c1"># If the connection to  SMSC is broken, we need to call `Client.re_establish_conn_bind`.</span>
            <span class="c1"># That method is only called by `Client.send_data`. Thus someone has to call `Client.send_data` even</span>
            <span class="c1"># when the connection is broken in order for it to call `re_establish_conn_bind` and restore connection</span>
            <span class="c1"># That someone is `enquire_link`. This is why in this block we have `enquire_link` and logging it at DEBUG level</span>
            <span class="c1"># and we do not return</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;smpp_command `</span><span class="si">{0}</span><span class="s2">` cannot be sent to SMSC when the client session state is `</span><span class="si">{1}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
                    <span class="s2">&quot;current_session_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="c1"># do not raise or return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">==</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">OPEN</span> <span class="ow">and</span> <span class="n">smpp_command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSMITTER</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_RECEIVER</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="c1"># only the smpp_command&#39;s listed above are allowed by SMPP spec to be sent</span>
            <span class="c1"># if current_session_state == SmppSessionState.OPEN</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;smpp_command `</span><span class="si">{0}</span><span class="s2">` cannot be sent to SMSC when the client session state is `</span><span class="si">{1}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
                    <span class="s2">&quot;current_session_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="c1"># do not raise, we do not want naz-cli to exit</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">is_closing</span><span class="p">():</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_establish_conn_bind</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># call user&#39;s hook for requests</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">to_smsc</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span> <span class="n">pdu</span><span class="o">=</span><span class="n">msg</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;to_smsc hook error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
                <span class="c1"># make mypy happy; https://github.com/python/mypy/issues/4805</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamWriter</span><span class="p">)</span>

            <span class="c1"># We use writer.drain() which is a flow control method that interacts with the IO write buffer.</span>
            <span class="c1"># When the size of the buffer reaches the high watermark,</span>
            <span class="c1"># drain blocks until the size of the buffer is drained down to the low watermark and writing can be resumed.</span>
            <span class="c1"># When there is nothing to wait for, the drain() returns immediately.</span>
            <span class="c1"># ref: https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter.drain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">drain_lock</span><span class="p">:</span>
                <span class="c1"># see: https://github.com/komuw/naz/issues/114</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER</span><span class="p">:</span>
                <span class="c1"># if we have successfully sent a bind_transceiver request, we can set session state to `BOUND_TRX`</span>
                <span class="c1"># Ideally, you should only set state to `BOUND_TRX` once SMSC sends back a successful `BIND_TRANSCEIVER_RESP`</span>
                <span class="c1"># However, an SMSC may fail to do so. This is especially true when sending `re_establish_conn_bind`</span>
                <span class="c1"># hack!! bad!!</span>
                <span class="c1"># TODO: fix this</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">BOUND_TRX</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="ne">ConnectionError</span><span class="p">,</span>
            <span class="ne">TimeoutError</span><span class="p">,</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">herror</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># https://docs.python.org/3/library/socket.html#exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to write to SMSC&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.dequeue_messages"><a class="viewcode-back" href="../../client.html#naz.client.Client.dequeue_messages">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">dequeue_messages</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">TESTING</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">protocol</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In a loop; dequeues items from the :attr:`broker &lt;Client.broker&gt;` and sends them to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TESTING: indicates whether this method is been called while running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dequeue_retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;cleanly shutting down client.&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;shutdown&quot;</span><span class="p">:</span> <span class="s2">&quot;shutdown&quot;</span><span class="p">}</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">!=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">BOUND_TRX</span><span class="p">:</span>
                <span class="c1"># If the connection to SMSC is broken, there&#39;s no need to try and send messages</span>
                <span class="c1"># sleep and wait for `Client.re_establish_conn_bind` to do its thing.</span>
                <span class="c1"># this same thing cannot be done for `enquire_link` since we rely on it to kick on `re_establish_conn_bind`</span>
                <span class="n">retry_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_timeout</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;current_session_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;awaiting naz to change session state to `BOUND_TRX`. sleeping for </span><span class="si">{0:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">retry_after</span>
                        <span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;awaiting naz to change session state to `BOUND_TRX`&quot;</span><span class="p">}</span>

            <span class="c1"># TODO: there are so many try-except classes in this func.</span>
            <span class="c1"># do something about that.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># check with throttle handler</span>
                <span class="n">send_request</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="o">.</span><span class="n">allow_request</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;dequeue_messages error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">send_request</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># rate limit ourselves</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">rateLimiter</span><span class="o">.</span><span class="n">limit</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;dequeue_messages error&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">proto_msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">dequeue</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">dequeue_retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">poll_queue_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_after</span><span class="p">(</span><span class="n">dequeue_retry_count</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;dequeue_messages error. sleeping for </span><span class="si">{0:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">poll_queue_interval</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;dequeue_retry_count&quot;</span><span class="p">:</span> <span class="n">dequeue_retry_count</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;shutdown&quot;</span><span class="p">:</span> <span class="s2">&quot;shutdown&quot;</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                        <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;broker_error&quot;</span><span class="p">:</span> <span class="s2">&quot;broker_error&quot;</span><span class="p">}</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_queue_interval</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># we didn&#39;t fail to dequeue a message</span>
                <span class="n">dequeue_retry_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log_id</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">log_id</span>
                    <span class="n">proto_msg</span><span class="o">.</span><span class="n">version</span>  <span class="c1"># version is a required field</span>
                    <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">smpp_command</span>
                    <span class="n">hook_metadata</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">hook_metadata</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proto_msg</span><span class="p">,</span> <span class="n">protocol</span><span class="o">.</span><span class="n">SubmitSM</span><span class="p">):</span>
                        <span class="n">short_message</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">short_message</span>
                        <span class="n">source_addr</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">source_addr</span>
                        <span class="n">destination_addr</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">destination_addr</span>
                        <span class="n">full_pdu</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_submit_sm_pdu</span><span class="p">(</span><span class="n">proto_msg</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proto_msg</span><span class="p">,</span> <span class="n">protocol</span><span class="o">.</span><span class="n">DeliverSmResp</span><span class="p">):</span>
                        <span class="n">full_pdu</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_deliver_sm_pdu</span><span class="p">(</span><span class="n">proto_msg</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proto_msg</span><span class="p">,</span> <span class="n">protocol</span><span class="o">.</span><span class="n">EnquireLinkResp</span><span class="p">):</span>
                        <span class="n">full_pdu</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_enquire_link_resp_pdu</span><span class="p">(</span><span class="n">proto_msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># TODO: raise error</span>
                        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">proto_msg</span><span class="o">.</span><span class="n">pdu</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="ne">AttributeError</span><span class="p">(</span>
                        <span class="s2">&quot;enqueued message/object is missing required field: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;dequeue_messages error&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span>
                    <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                        <span class="s2">&quot;send_request&quot;</span><span class="p">:</span> <span class="n">send_request</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                    <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
                    <span class="k">return</span> <span class="n">proto_msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># throttle_handler didn&#39;t allow us to send request.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;send_request&quot;</span><span class="p">:</span> <span class="n">send_request</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="o">.</span><span class="n">throttle_delay</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.dequeue_messages&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;dequeue_messages error&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                    <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;throttle_handler_denied_request&quot;</span><span class="p">:</span> <span class="s2">&quot;throttle_handler_denied_request&quot;</span><span class="p">}</span>
                <span class="k">continue</span></div>

<div class="viewcode-block" id="Client.receive_data"><a class="viewcode-back" href="../../client.html#naz.client.Client.receive_data">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TESTING</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In a loop; read bytes from the network connected to SMSC and hand them over to the :func:`_parse_response_pdu &lt;Client._parse_response_pdu&gt;` method for parsing.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TESTING: indicates whether this method is been called while running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;cleanly shutting down client.&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">!=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">BOUND_TRX</span><span class="p">:</span>
                <span class="n">retry_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_timeout</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;naz is yet to bind to SMSC. sleeping for </span><span class="si">{0:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">retry_after</span>
                        <span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_establish_conn_bind</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">header_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
                    <span class="c1"># make mypy happy; https://github.com/python/mypy/issues/4805</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamReader</span><span class="p">)</span>

                <span class="c1"># `client.reader` and `client.writer` should not have timeouts since they are non-blocking</span>
                <span class="c1"># https://github.com/komuw/naz/issues/116</span>
                <span class="n">header_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">readexactly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">IncompleteReadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># see: https://github.com/komuw/naz/issues/135</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to read exactly </span><span class="si">{0}</span><span class="s2">bytes of smpp header.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="c1"># close connection. it will be automatically reconnected later</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unbind_and_disconnect</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                    <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
                    <span class="k">return</span> <span class="n">header_data</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="ne">ConnectionError</span><span class="p">,</span>
                <span class="ne">TimeoutError</span><span class="p">,</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">,</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">herror</span><span class="p">,</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">,</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to read from SMSC&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">header_data</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">poll_read_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_after</span><span class="p">(</span><span class="n">retry_count</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;no data received from SMSC. sleeping for </span><span class="si">{0:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">poll_read_interval</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="n">retry_count</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_read_interval</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we didn&#39;t fail to read from SMSC</span>
                <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># first 4bytes of header are the command_length</span>
            <span class="n">total_pdu_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">header_data</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">MSGLEN</span> <span class="o">=</span> <span class="n">total_pdu_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bytes_recd</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">bytes_recd</span> <span class="o">&lt;</span> <span class="n">MSGLEN</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
                        <span class="c1"># make mypy happy; https://github.com/python/mypy/issues/4805</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamReader</span><span class="p">)</span>

                    <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">MSGLEN</span> <span class="o">-</span> <span class="n">bytes_recd</span><span class="p">,</span> <span class="mi">2048</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="c1"># TODO: maybe we also need todo; `self.writer=None`</span>
                        <span class="c1"># so that the `re_establish_conn_bind` mechanism can kick in.</span>
                        <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;socket connection broken&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span>
                    <span class="ne">ConnectionError</span><span class="p">,</span>
                    <span class="ne">TimeoutError</span><span class="p">,</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">,</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">herror</span><span class="p">,</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">,</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to read from SMSC&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>

                    <span class="n">_read_smsc_interval</span> <span class="o">=</span> <span class="mf">62.00</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to read from SMSC. sleeping for </span><span class="si">{0:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">_read_smsc_interval</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">_read_smsc_interval</span><span class="p">)</span>
                    <span class="k">continue</span>  <span class="c1"># important so that we do not hit the bug: issues/135</span>
                <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">bytes_recd</span> <span class="o">=</span> <span class="n">bytes_recd</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

            <span class="n">full_pdu_data</span> <span class="o">=</span> <span class="n">header_data</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;full_pdu_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_to_log</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">full_pdu_data</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response_pdu</span><span class="p">(</span><span class="n">full_pdu_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
                <span class="k">return</span> <span class="n">full_pdu_data</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_parse_response_pdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdu</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take the bytes that have been read from network and parse them into their corresponding PDU.</span>
<span class="sd">        The resulting PDU is then handed over to :func:`command_handlers &lt;Client.command_handlers&gt;`</span>

<span class="sd">        Parameters:</span>
<span class="sd">            pdu: PDU in bytes, that have been read from network</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_pdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_to_log</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">pdu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._parse_response_pdu&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;pdu&quot;</span><span class="p">:</span> <span class="n">log_pdu</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">header_data</span> <span class="o">=</span> <span class="n">pdu</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span><span class="p">]</span>
        <span class="n">body_data</span> <span class="o">=</span> <span class="n">pdu</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="p">:]</span>
        <span class="n">command_id_header_data</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">command_status_header_data</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
        <span class="n">sequence_number_header_data</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">command_id</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">command_id_header_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">command_status</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">command_status_header_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">sequence_number_header_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># see: https://github.com/komuw/naz/issues/135</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._parse_response_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;parse SMSC response error.&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;pdu&quot;</span><span class="p">:</span> <span class="n">log_pdu</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="c1"># close connection</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unbind_and_disconnect</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">smpp_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_by_command_id_code</span><span class="p">(</span><span class="n">command_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">smpp_command</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;command_id:</span><span class="si">{0}</span><span class="s2"> is unknown.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._parse_response_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;command_id:</span><span class="si">{0}</span><span class="s2"> is unknown.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command_id</span><span class="p">),</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># get associated user supplied log_id if any</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._parse_response_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater get error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span><span class="p">(</span>
            <span class="n">pdu</span><span class="o">=</span><span class="n">pdu</span><span class="p">,</span>
            <span class="n">body_data</span><span class="o">=</span><span class="n">body_data</span><span class="p">,</span>
            <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
            <span class="n">command_status_value</span><span class="o">=</span><span class="n">command_status</span><span class="p">,</span>
            <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
            <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
            <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._parse_response_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;command_status&quot;</span><span class="p">:</span> <span class="n">command_status</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Client.command_handlers"><a class="viewcode-back" href="../../client.html#naz.client.Client.command_handlers">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">command_handlers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pdu</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">body_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">smpp_command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">command_status_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">log_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">hook_metadata</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This routes the various different SMPP PDU to their respective handlers.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            pdu: the full PDU as received from SMSC</span>
<span class="sd">            body_data: PDU body as received from SMSC</span>
<span class="sd">            smpp_command: type of PDU been received. eg bind_transceiver_resp</span>
<span class="sd">            command_status_value: the response code from SMSC for a specific PDU</span>
<span class="sd">            sequence_number: SMPP sequence_number</span>
<span class="sd">            log_id: a unique identify of this request</span>
<span class="sd">            hook_metadata: additional metadata that you would like to be passed on to hooks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">commandStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_by_command_status_value</span><span class="p">(</span>
            <span class="n">command_status_value</span><span class="o">=</span><span class="n">command_status_value</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">commandStatus</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.command_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;command_status: `</span><span class="si">{0}</span><span class="s2">` is unknown.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command_status_value</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="c1"># we got an error from SMSC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.command_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;command_status&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.command_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;command_status&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># call throttling handler</span>
            <span class="k">if</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_RTHROTTLED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_RMSGQFUL</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="o">.</span><span class="n">throttled</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="o">.</span><span class="n">not_throttled</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.command_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># call user&#39;s hook for responses</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">from_smsc</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">commandStatus</span><span class="p">,</span>
                <span class="n">pdu</span><span class="o">=</span><span class="n">pdu</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.command_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;from_smsc hook error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">smpp_command</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND_RESP</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM</span><span class="p">,</span>  <span class="c1"># We dont expect SMSC to send `submit_sm` to us.</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM_RESP</span><span class="p">,</span>
            <span class="c1"># we will never send a deliver_sm request to SMSC, which means we never</span>
            <span class="c1"># have to handle deliver_sm_resp</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK_RESP</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">GENERIC_NACK</span><span class="p">,</span>  <span class="c1"># we can ignore this</span>
        <span class="p">]:</span>
            <span class="c1"># we never have to handle this</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER_RESP</span><span class="p">:</span>
            <span class="c1"># the body of `bind_transceiver_resp` only has `system_id` which is a</span>
            <span class="c1"># C-Octet String of variable length upto 16 octets</span>
            <span class="k">if</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">BOUND_TRX</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND</span><span class="p">:</span>
            <span class="c1"># we need to handle this since we need to send unbind_resp</span>
            <span class="c1"># it has no body</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">unbind_resp</span><span class="p">(</span><span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM_RESP</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># the body of this only has `message_id` which is a C-Octet String of variable length upto 65 octets.</span>
                <span class="c1"># This field contains the SMSC message_id of the submitted message.</span>
                <span class="c1"># It may be used at a later stage to query the status of a message, cancel</span>
                <span class="c1"># or replace the message.</span>
                <span class="n">_message_id</span> <span class="o">=</span> <span class="n">body_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">smsc_message_id</span> <span class="o">=</span> <span class="n">_message_id</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                    <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                    <span class="n">smsc_message_id</span><span class="o">=</span><span class="n">smsc_message_id</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.command_handlers&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM</span><span class="p">:</span>
            <span class="c1"># HEADER::</span>
            <span class="c1"># command_length, int, 4octet</span>
            <span class="c1"># command_id, int, 4octet. `deliver_sm`</span>
            <span class="c1"># command_status, int, 4octet. Unused, Set to NULL.</span>
            <span class="c1"># sequence_number, int, 4octet. The associated `deliver_sm_resp` PDU should echo the same sequence_number.</span>

            <span class="c1"># BODY::</span>
            <span class="c1"># see section 4.6.1 of smpp v3.4 spec</span>
            <span class="c1"># we want to handle this pdu, bcoz we are expected to send back deliver_sm_resp</span>
            <span class="c1"># the body of this has the following params</span>
            <span class="c1"># service_type, C-Octet String, max 6 octets</span>
            <span class="c1"># source_addr_ton, Int, 1 octet, can be NULL</span>
            <span class="c1"># source_addr_npi, Int, 1 octet, can be NULL</span>
            <span class="c1"># source_addr, C-Octet String, max 21 octet, can be NULL</span>
            <span class="c1"># dest_addr_ton, Int, 1 octet</span>
            <span class="c1"># dest_addr_npi, Int, 1 octet</span>
            <span class="c1"># destination_addr,  C-Octet String, max 21 octet</span>
            <span class="c1"># esm_class, Int, 1 octet</span>
            <span class="c1"># protocol_id, Int, 1 octet</span>
            <span class="c1"># priority_flag, Int, 1 octet</span>
            <span class="c1"># schedule_delivery_time, C-Octet String, 1 octet, must be set to NULL.</span>
            <span class="c1"># validity_period, C-Octet String, 1 octet, must be set to NULL.</span>
            <span class="c1"># registered_delivery, Int, 1 octet</span>
            <span class="c1"># replace_if_present_flag, Int, 1 octet, must be set to NULL.</span>
            <span class="c1"># data_coding, Int, 1 octet</span>
            <span class="c1"># sm_default_msg_id, Int, 1 octet, must be set to NULL.</span>
            <span class="c1"># sm_length, Int, 1 octet.It is length of short message user data in octets.</span>
            <span class="c1"># short_message, C-Octet String, 0-254 octet</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliver_sm_resp</span><span class="p">(</span><span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># get associated user supplied log_id if any</span>
                <span class="n">target_tag</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;H&quot;</span><span class="p">,</span> <span class="n">SmppOptionalTag</span><span class="o">.</span><span class="n">receipted_message_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target_tag</span> <span class="ow">in</span> <span class="n">body_data</span><span class="p">:</span>
                    <span class="c1"># the PDU contains a `receipted_message_id` TLV optional tag</span>
                    <span class="n">position_of_target_tag</span> <span class="o">=</span> <span class="n">body_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">target_tag</span><span class="p">)</span>
                    <span class="c1"># since a tag is 2 integer in size lets skip one more.</span>
                    <span class="n">end_of_target_tag</span> <span class="o">=</span> <span class="n">position_of_target_tag</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="c1"># since after a tag, comes a tag_length which is 2 integer in size</span>
                    <span class="c1"># lets also skip that</span>
                    <span class="n">end_of_target_tag_length</span> <span class="o">=</span> <span class="n">end_of_target_tag</span> <span class="o">+</span> <span class="mi">2</span>
                    <span class="n">end_of_target_tag_length</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">end_of_target_tag_length</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>  <span class="c1"># because of c-octet string null termination</span>
                    <span class="c1"># tag_value is of size 1 - 65</span>
                    <span class="n">end_of_tag_value</span> <span class="o">=</span> <span class="n">end_of_target_tag_length</span> <span class="o">+</span> <span class="mi">65</span>
                    <span class="n">tag_value</span> <span class="o">=</span> <span class="n">body_data</span><span class="p">[</span><span class="n">end_of_target_tag_length</span><span class="p">:</span><span class="n">end_of_tag_value</span><span class="p">]</span>
                    <span class="n">_tag_value</span> <span class="o">=</span> <span class="n">tag_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                    <span class="p">)</span>  <span class="c1"># change variable names to make mypy happy</span>
                    <span class="n">t_value</span> <span class="o">=</span> <span class="n">_tag_value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
                    <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                        <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                        <span class="n">smsc_message_id</span><span class="o">=</span><span class="n">t_value</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.command_handlers&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater get error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK</span><span class="p">:</span>
            <span class="c1"># we have to handle this. we have to return enquire_link_resp</span>
            <span class="c1"># it has no body</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enquire_link_resp</span><span class="p">(</span><span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.command_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;command_status&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;the smpp_command: `</span><span class="si">{0}</span><span class="s2">` has not been implemented in naz. please create a github issue&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">smpp_command</span>
                    <span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Client.unbind"><a class="viewcode-back" href="../../client.html#naz.client.Client.unbind">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">unbind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send an UNBIND pdu to SMSC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_pdu_length</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="mh">0x00000000</span>  <span class="c1"># not used for `unbind`</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span><span class="p">:</span>
            <span class="c1"># prevent third party sequence_generators from ruining our party</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;the sequence_number: </span><span class="si">{0}</span><span class="s2"> is greater than the max: </span><span class="si">{1}</span><span class="s2"> allowed by SMPP spec.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sequence_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                <span class="n">hook_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>
        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="c1"># dont queue unbind in SimpleBroker since we dont want it to be behind 10k msgs etc</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.shutdown"><a class="viewcode-back" href="../../client.html#naz.client.Client.shutdown">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleanly shutdown this client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.shutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;intiating shutdown&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SHOULD_SHUT_DOWN</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unbind_and_disconnect</span><span class="p">()</span>

        <span class="c1"># sleep so that client can:</span>
        <span class="c1"># - stop consuming from queue</span>
        <span class="c1"># - finish sending any SMSes it may have already picked from queue</span>
        <span class="c1"># - stop sending `enquire_link` requests</span>
        <span class="c1"># - send unbind to SMSC</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drain_duration</span><span class="p">)</span>  <span class="c1"># asyncio.sleep so that we do not block eventloop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.shutdown&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">})</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_unbind_and_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        unbind from SMSC and close network connection.</span>
<span class="sd">        This is usually done in two situations;</span>
<span class="sd">          - when shutting down a naz client</span>
<span class="sd">          - if we got into an unrecoverable state and need to start over; issues/135</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._unbind_and_disconnect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
            <span class="c1"># make mypy happy; https://github.com/python/mypy/issues/4805</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamWriter</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">transport</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">transports</span><span class="o">.</span><span class="n">Transport</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 1. set buffers to 0</span>
            <span class="c1"># 2. unbind</span>
            <span class="c1"># 3. drain</span>
            <span class="c1"># 4. close connection</span>
            <span class="c1"># in that order</span>

            <span class="c1"># see: https://github.com/komuw/naz/issues/117</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">set_write_buffer_limits</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># pytype: disable=attribute-error</span>
            <span class="c1"># https://github.com/google/pytype/issues/350</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">drain_lock</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="ne">ConnectionError</span><span class="p">,</span>
            <span class="ne">TimeoutError</span><span class="p">,</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">herror</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">,</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._unbind_and_disconnect&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;unable to write to SMSC&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client._unbind_and_disconnect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">})</span></div>


<div class="viewcode-block" id="NazClientError"><a class="viewcode-back" href="../../client.html#naz.client.NazClientError">[docs]</a><span class="k">class</span> <span class="nc">NazClientError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Error raised when there&#39;s an error instantiating a naz Client.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Komu Wairagu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>